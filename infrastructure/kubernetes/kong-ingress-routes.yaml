apiVersion: v1
kind: Service
metadata:
  name: kong-proxy-external
  namespace: ecommerce
  annotations:
    konghq.com/override: "kong-gateway"
spec:
  type: LoadBalancer
  selector:
    app.kubernetes.io/name: kong
  ports:
  - name: proxy
    port: 80
    targetPort: 8000
    protocol: TCP
---
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: rate-limiting-plugin
  namespace: ecommerce
config:
  minute: 100
  hour: 5000
  policy: local
plugin: rate-limiting
---
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: cors-plugin
  namespace: ecommerce
config:
  origins:
  - "*"
  methods:
  - GET
  - POST
  - PUT
  - PATCH
  - DELETE
  headers:
  - Accept
  - Content-Type
  - Authorization
  credentials: true
  max_age: 3600
plugin: cors
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kong-user-service
  namespace: ecommerce
  annotations:
    konghq.com/plugins: rate-limiting-plugin,cors-plugin
    konghq.com/strip-path: "false"
spec:
  ingressClassName: kong
  rules:
  - http:
      paths:
      - path: /api/v1/users
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 8081
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kong-product-service
  namespace: ecommerce
  annotations:
    konghq.com/plugins: rate-limiting-plugin,cors-plugin
    konghq.com/strip-path: "false"
spec:
  ingressClassName: kong
  rules:
  - http:
      paths:
      - path: /api/v1/products
        pathType: Prefix
        backend:
          service:
            name: product-service
            port:
              number: 8082
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kong-order-service
  namespace: ecommerce
  annotations:
    konghq.com/plugins: rate-limiting-plugin,cors-plugin
    konghq.com/strip-path: "false"
spec:
  ingressClassName: kong
  rules:
  - http:
      paths:
      - path: /api/v1/orders
        pathType: Prefix
        backend:
          service:
            name: order-service
            port:
              number: 8083
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kong-frontend
  namespace: ecommerce
  annotations:
    konghq.com/strip-path: "false"
spec:
  ingressClassName: kong
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 80
